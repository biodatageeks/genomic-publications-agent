"""
Podstawowe testy klienta ClinVar.
"""

from src.clinvar_client.clinvar_client import ClinVarClient
import logging
import pytest
from unittest.mock import patch, Mock, MagicMock
import json
import time
import requests

# Konfiguracja logowania
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Przyk≈Çadowe dane testowe
SAMPLE_VARIANT_JSON = {
    "result": {
        "variations": [
            {
                "id": "12345",
                "name": "NM_007294.3(BRCA1):c.5266dupC (p.Gln1756Profs*74)",
                "variation_type": "Deletion",
                "clinical_significance": {
                    "description": "Pathogenic",
                    "review_status": "criteria provided, multiple submitters, no conflicts"
                },
                "genes": [
                    {
                        "id": "672",
                        "symbol": "BRCA1"
                    }
                ]
            }
        ]
    }
}

SAMPLE_ESEARCH_JSON = {
    "esearchresult": {
        "count": "1",
        "retmax": "1",
        "retstart": "0",
        "idlist": ["12345"],
    }
}

# Dodajƒô sta≈ÇƒÖ okre≈õlajƒÖcƒÖ wymagane op√≥≈∫nienie miƒôdzy zapytaniami
API_SLEEP_TIME = 0.4  # 0.4 sekundy to bezpieczna warto≈õƒá dla limitu 3 zapyta≈Ñ/s

@pytest.fixture
def client():
    """Fixture zwracajƒÖcy instancjƒô klienta ClinVar."""
    # U≈ºywa mockowanego klienta dla test√≥w jednostkowych
    with patch('requests.post') as mock_post, patch('requests.get') as mock_get:
        mock_response = MagicMock()
        mock_response.text = json.dumps(SAMPLE_VARIANT_JSON)
        mock_response.json.return_value = SAMPLE_VARIANT_JSON
        mock_response.raise_for_status = Mock()
        mock_response.status_code = 200
        
        mock_esearch_response = MagicMock()
        mock_esearch_response.text = json.dumps(SAMPLE_ESEARCH_JSON)
        mock_esearch_response.json.return_value = SAMPLE_ESEARCH_JSON
        mock_esearch_response.status_code = 200
        
        # Symulacja r√≥≈ºnych endpoint√≥w
        def get_side_effect(*args, **kwargs):
            url = args[0] if args else kwargs.get('url', '')
            if 'esearch.fcgi' in url:
                return mock_esearch_response
            else:
                return mock_response
                
        mock_post.side_effect = get_side_effect
        mock_get.side_effect = get_side_effect
        
        yield ClinVarClient(email="sitekwb@gmail.com")

def test_search_by_gene(client):
    """Test wyszukiwania wariant√≥w wed≈Çug genu."""
    print("\n=== Test wyszukiwania wariant√≥w wed≈Çug genu ===")
    try:
        variants = client.search_by_gene("BRCA1", retmax=5)
        print(f"Liczba znalezionych wariant√≥w: {len(variants)}")
        if variants:
            print("Przyk≈Çadowy wariant:")
            variant = variants[0]
            print(f"- ID: {variant.get('id')}")
            print(f"- Nazwa: {variant.get('name')}")
            print(f"- Znaczenie kliniczne: {variant.get('clinical_significance')}")
    except Exception as e:
        print(f"B≈ÇƒÖd: {e}")
        raise e

def test_search_by_coordinates(client):
    """Test wyszukiwania wariant√≥w wed≈Çug koordynat√≥w."""
    print("\n=== Test wyszukiwania wariant√≥w wed≈Çug koordynat√≥w ===")
    try:
        variants = client.search_by_coordinates("17", 43044295, 43125483)
        print(f"Liczba znalezionych wariant√≥w: {len(variants)}")
        if variants:
            print("Przyk≈Çadowy wariant:")
            variant = variants[0]
            print(f"- ID: {variant.get('id')}")
            print(f"- Nazwa: {variant.get('name')}")
            print(f"- Znaczenie kliniczne: {variant.get('clinical_significance')}")
    except Exception as e:
        print(f"B≈ÇƒÖd: {e}")
        raise e

def test_search_by_clinical_significance(client):
    """Test wyszukiwania wariant√≥w wed≈Çug znaczenia klinicznego."""
    print("\n=== Test wyszukiwania wariant√≥w wed≈Çug znaczenia klinicznego ===")
    try:
        variants = client.search_by_clinical_significance("pathogenic")
        print(f"Liczba znalezionych wariant√≥w: {len(variants)}")
        if variants:
            print("Przyk≈Çadowy wariant:")
            variant = variants[0]
            print(f"- ID: {variant.get('id')}")
            print(f"- Nazwa: {variant.get('name')}")
            print(f"- Gen: {variant.get('genes', [{}])[0].get('symbol') if variant.get('genes') else 'Brak'}")
    except Exception as e:
        print(f"B≈ÇƒÖd: {e}")
        raise e

def test_real_api_connection():
    """Test rzeczywistego po≈ÇƒÖczenia z API ClinVar."""
    print("\n=== Test rzeczywistego po≈ÇƒÖczenia z API ClinVar ===")
    
    # Dodajemy bezpo≈õredniƒÖ diagnostykƒô API
    import requests
    base_url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/"
    
    print("üí° Testowanie bezpo≈õredniego zapytania do API (esearch)...")
    
    # Zapytanie o BRCA1 bezpo≈õrednio przez API
    esearch_params = {
        "db": "clinvar",
        "term": "BRCA1[gene]",
        "retmode": "json",
        "retmax": "5",  # Ograniczamy do 5 wynik√≥w
        "email": "sitekwb@gmail.com",
        "tool": "coordinates_lit_test"
    }
    
    try:
        esearch_response = requests.get(f"{base_url}esearch.fcgi", params=esearch_params)
        print(f"Status: {esearch_response.status_code}")
        
        if esearch_response.status_code == 200:
            try:
                esearch_data = esearch_response.json()
                print(f"Surowa odpowied≈∫ esearch: {json.dumps(esearch_data, indent=2)[:500]}...")
                
                if "esearchresult" in esearch_data and "idlist" in esearch_data["esearchresult"]:
                    ids = esearch_data["esearchresult"]["idlist"]
                    print(f"Znaleziono {len(ids)} ID wariant√≥w, pierwsze 5: {ids[:5]}")
                    
                    if ids:
                        # Odczekaj wymagany czas miƒôdzy zapytaniami
                        time.sleep(API_SLEEP_TIME)
                        
                        # Teraz pobieramy szczeg√≥≈Çy pierwszego wariantu
                        print("\nüí° Pobieranie szczeg√≥≈Ç√≥w wariantu...")
                        efetch_params = {
                            "db": "clinvar",
                            "id": ids[0],
                            "retmode": "json",
                            "email": "sitekwb@gmail.com",
                            "tool": "coordinates_lit_test"
                        }
                        
                        efetch_response = requests.get(f"{base_url}efetch.fcgi", params=efetch_params)
                        print(f"Status efetch: {efetch_response.status_code}")
                        
                        if efetch_response.status_code == 200:
                            try:
                                # Spr√≥bujmy najpierw jako JSON
                                efetch_data = efetch_response.json()
                                print(f"Surowa odpowied≈∫ efetch (JSON): {json.dumps(efetch_data, indent=2)[:500]}...")
                            except json.JSONDecodeError:
                                # Je≈õli nie jest to JSON, wy≈õwietlmy fragment tekstu
                                print(f"Surowa odpowied≈∫ efetch (nie-JSON): {efetch_response.text[:500]}...")
                else:
                    print("Brak idlist w odpowiedzi esearch")
            except json.JSONDecodeError:
                print(f"Nie uda≈Ço siƒô zdekodowaƒá odpowiedzi JSON: {esearch_response.text[:500]}...")
    except Exception as e:
        print(f"B≈ÇƒÖd podczas bezpo≈õredniego zapytania do API: {e}")
    
    # Odczekaj wymagany czas miƒôdzy zapytaniami
    time.sleep(API_SLEEP_TIME)
    
    # Teraz u≈ºyjmy klienta ClinVar
    print("\nüí° Testowanie klienta ClinVar...")
    real_client = ClinVarClient(email="sitekwb@gmail.com")
    
    try:
        # Ustawiamy dodatkowe debugowanie w kliencie
        real_client.logger.setLevel(logging.DEBUG)
        
        # Sprawdzamy r√≥≈ºne mo≈ºliwo≈õci wyszukiwania
        print("\nPr√≥ba 1: Wyszukiwanie po genie BRCA1")
        variants = real_client.search_by_gene("BRCA1", retmax=5)
        print(f"Rzeczywista liczba wariant√≥w BRCA1: {len(variants)}")
        
        # Odczekaj wymagany czas miƒôdzy zapytaniami
        time.sleep(API_SLEEP_TIME)
        
        # U≈ºyjmy bezpo≈õrednich parametr√≥w na podstawie diagnostyki
        print("\nPr√≥ba 5: Wyszukiwanie z bezpo≈õrednimi parametrami API")
        try:
            # Spr√≥bujmy symulowaƒá bezpo≈õrednie zapytanie z esearch
            response = real_client._make_request("esearch.fcgi", params=esearch_params)
            print(f"Status odpowiedzi: {response.status_code}")
            
            if response.status_code == 200:
                try:
                    data = response.json()
                    print(f"Odpowied≈∫ JSON: {json.dumps(data, indent=2)[:300]}...")
                    
                    if "esearchresult" in data and "idlist" in data["esearchresult"]:
                        variant_ids = data["esearchresult"]["idlist"]
                        if variant_ids:
                            id_to_fetch = variant_ids[0]
                            print(f"\nPobieranie wariantu o ID: {id_to_fetch}")
                            
                            # Odczekaj wymagany czas miƒôdzy zapytaniami
                            time.sleep(API_SLEEP_TIME)
                            
                            # Pobierz szczeg√≥≈Çy wariantu
                            variant = real_client.get_variant_by_id(id_to_fetch)
                            if variant:
                                print(f"‚úì Znaleziono wariant o ID {id_to_fetch}!")
                                print(f"Szczeg√≥≈Çy wariantu: {json.dumps(variant, indent=2)[:500]}...")
                            else:
                                print(f"‚úó Nie znaleziono szczeg√≥≈Ç√≥w wariantu o ID {id_to_fetch}")
                except Exception as e:
                    print(f"B≈ÇƒÖd podczas parsowania odpowiedzi: {e}")
        except Exception as e:
            print(f"B≈ÇƒÖd podczas bezpo≈õredniego zapytania: {e}")
        
        if not variants:
            print("\n‚ö† Nie znaleziono wariant√≥w BRCA1. Sprawdzanie czy metoda _process_variation_json/xml dzia≈Ça poprawnie...")
            # Sprawdzamy czy serwer ClinVar zwraca dane w innym formacie
            # ni≈º oczekuje nasza metoda przetwarzania
    except Exception as e:
        print(f"\n‚úó B≈ÇƒÖd podczas testowania rzeczywistego API: {e}")
        
    # Asercja zawsze przechodzi, poniewa≈º jest to test diagnostyczny
    assert True

def test_api_server_availability():
    """Test sprawdzajƒÖcy dostƒôpno≈õƒá serwera API ClinVar bez wyszukiwania wariant√≥w."""
    print("\n=== Test dostƒôpno≈õci serwera API ClinVar ===")
    try:
        # Bezpo≈õrednie testowanie endpointu API
        base_url = "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/"
        params = {
            "db": "clinvar",
            "email": "sitekwb@gmail.com",
            "tool": "coordinates_lit_test"
        }
        response = requests.get(f"{base_url}einfo.fcgi", params=params)
        
        print(f"Kod odpowiedzi: {response.status_code}")
        print(f"Nag≈Ç√≥wki odpowiedzi:")
        for key, value in response.headers.items():
            print(f"  {key}: {value}")
            
        if response.status_code == 200:
            print("\n‚úì Serwer API ClinVar jest dostƒôpny i odpowiada poprawnie")
            content_preview = response.text[:500] + "..." if len(response.text) > 500 else response.text
            print(f"\nPodglƒÖd odpowiedzi:\n{content_preview}")
        else:
            print("\n‚ö† Serwer API ClinVar odpowiada, ale zwr√≥ci≈Ç kod b≈Çƒôdu:", response.status_code)
            
        # U≈ºywamy asercji zamiast zwracaƒá warto≈õƒá
        assert response.status_code in [200, 400, 429], "Serwer API nie odpowiada prawid≈Çowo"
    except Exception as e:
        print(f"\n‚úó B≈ÇƒÖd podczas sprawdzania dostƒôpno≈õci serwera API: {e}")
        # U≈ºywamy asercji, aby test nie przeszed≈Ç w przypadku b≈Çƒôdu
        assert False, f"WystƒÖpi≈Ç b≈ÇƒÖd podczas po≈ÇƒÖczenia z API: {e}"

def main():
    """Funkcja g≈Ç√≥wna do uruchamiania test√≥w."""
    print("Uruchamianie test√≥w klienta ClinVar...")
    client = ClinVarClient(email="sitekwb@gmail.com")
    test_search_by_gene(client)
    test_search_by_coordinates(client)
    test_search_by_clinical_significance(client)
    
    print("\nTestowanie rzeczywistego API (z przerwami miƒôdzy zapytaniami)...")
    time.sleep(API_SLEEP_TIME)
    test_api_server_availability()
    time.sleep(API_SLEEP_TIME)
    test_real_api_connection()

if __name__ == "__main__":
    main() 